---
title: "DMR visuals"
author: "Khaled Fouda"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = F, eval = T, cache = TRUE)
library(tidyverse)
library(knitr)
```

```{r fig.height=8, fig.width=8}
setwd("/mnt/campus/math/research/kfouda/main/HEC/Melina/latest/cas_etude/")  




chromosome = "chr2"
note = "_subset_Blood"
correction <- function(alpha,N) alpha
alpha = 1e-4
region_length <- 1e3
dmr.info <- data.frame()

dmr.info <- readRDS(paste0("new_data/dmr_info_",note, ".rds"))
methyl.info <- readRDS(paste0("new_data/methyl_info_",note, ".rds"))

# dmr.info %>%
#    mutate(chromosome = as.factor(chromosome)) %>% 
#    group_by(chromosome) %>%
#    summarise(mean(region_length)) %>%
#    arrange(`mean(region_length)`) %>% 
#    ggplot(aes(reorder(chromosome,`mean(region_length)`), `mean(region_length)`)) +
#    geom_bar(stat = "identity")
```


```{r fig.height=8, fig.width=8}


dmr.info %>%
   mutate(chromosome = as.numeric(gsub("chr", "", chromosome))) %>%
   filter(region_length != 0) %>% 
   group_by(chromosome) %>% 
   summarise(`# of DMRs` = length(site), 
             `# of sites in DMRs` = sum(region_length)) %>%
   ungroup() %>%
   arrange(chromosome) %>%
   mutate(chromosome = as.factor(chromosome)) %>%
   kable(format = "pipe")




```


```{r fig.height=10, fig.width=10}

dmr.info %>%
   mutate(chromosome = as.numeric(gsub("chr", "", chromosome))) %>%
   filter(region_length != 0, chromosome !=9, chromosome <=6) %>%
   ggplot(aes(x = region_length)) +
   geom_histogram(bins = 100, fill = "steelblue", color = "black") +
   theme_minimal() +
   labs(
      title = "Distribution of Number of Sites per Single DMR",
      x = "Number of Sites",
      y = "Count"
   ) +
   theme(
      plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
      axis.title.x = element_text(size = 12, colour = "steelblue", face="bold"),
      axis.title.y = element_text(size = 12, colour = "steelblue", face="bold"),
      axis.text.x = element_text(angle = 0, hjust = 1, face = "bold", color="red"),
      axis.text.y = element_text(angle = 0, hjust = 1, face = "bold", color="red")
   ) +
   facet_wrap(~chromosome, labeller = label_both, nrow=3)


```


```{r fig.height=10, fig.width=10}

dmr.info %>%
   mutate(chromosome = as.numeric(gsub("chr", "", chromosome))) %>%
   filter(region_length != 0, chromosome !=9, chromosome >6) %>%
   ggplot(aes(x = region_length)) +
   geom_histogram(bins = 100, fill = "steelblue", color = "black") +
   theme_minimal() +
   labs(
      title = "Distribution of Number of Sites per Single DMR",
      x = "Number of Sites",
      y = "Count"
   ) +
   theme(
      plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
      axis.title.x = element_text(size = 12, colour = "steelblue", face="bold"),
      axis.title.y = element_text(size = 12, colour = "steelblue", face="bold"),
      axis.text.x = element_text(angle = 0, hjust = 1, face = "bold", color="red"),
      axis.text.y = element_text(angle = 0, hjust = 1, face = "bold", color="red")
   ) +
   facet_wrap(~chromosome, labeller = label_both, nrow=3)


```

```{r fig.height=8, fig.width=8}
methyl.info %>%
   mutate(chromosome = as.numeric(gsub("chr", "", chromosome))) %>%
   arrange(chromosome) %>%
   mutate(dmr = ifelse(dmr==TRUE, "DMR", "Not DMR")) %>% 
   mutate(chromosome = as.factor(chromosome)) %>%
   ggplot(aes(x = Methylation, group = chromosome)) +
   geom_density(aes(y=after_stat(scaled)), fill="steelblue", color="black",alpha=0.01) +
   facet_wrap(~ dmr, nrow = 2) +
   theme_minimal() +
   labs(
      title = "Methylation Distribution Comparison between DMR and non-DMR sites",
      subtitle = "Different lines for different chromosomes",
      x = "Methylation Level",
      y = "Density"
   ) +
   theme(
      plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
      axis.title.x = element_text(size = 12),
      axis.title.y = element_text(size = 12),
      strip.text = element_text(size = 12, face = "bold"), 
      axis.text.x = element_text(angle = 0, hjust = 1),
      panel.spacing = unit(1, "lines"),
      plot.background = element_blank(),
      panel.grid.minor = element_blank()
   )

```


```{r fig.height=8, fig.width=8}

methyl.info %>%
   filter(dmr == TRUE) %>%
   mutate(chromosome = as.numeric(gsub("chr", "", chromosome))) %>%
   arrange(desc(chromosome)) %>%
   mutate(chromosome = as.factor(chromosome)) %>%
   ggplot(aes(x = site, y = chromosome)) +
   geom_point(alpha = 1, color = "steelblue", size = 1) +  
   theme_minimal() +
   labs(
      title = "DMRs' Sites location per Chromosome",
      subtitle = "To visually identify common DMR sites among chromosomes, if any.",
      x = "Site",
      y = "Chromosome"
   ) +
   theme(
      plot.title = element_text(hjust = 0.5, size = 16, face = "bold"),
      axis.title.x = element_text(size = 12),
      axis.title.y = element_text(size = 12),
      axis.text.x = element_text(angle = 0, hjust = 1),
      axis.text.y = element_text(angle = 0, vjust = 1),
      panel.grid = element_blank()
   )


```


```{r fig.height=8, fig.width=8}
dmr.info %>%
   mutate(chromosome = as.numeric(gsub("chr", "", chromosome))) %>%
   filter(region_length != 0) %>% 
   group_by(chromosome) %>%
   summarise(mean_length = mean(region_length), 
             sd_length = sd(region_length),
             max_length = max(region_length)) %>%
   ungroup() %>%
   arrange(chromosome) %>%
   mutate(chromosome = as.factor(chromosome)) %>% 
   ggplot(aes(x = fct_inorder(chromosome), y = mean_length)) +
   geom_bar(stat = "identity", fill = "steelblue") +
   geom_bar(aes(y=max_length), stat = "identity", fill = "steelblue", alpha=0.5) +
   geom_errorbar(aes(ymin = mean_length - sd_length, ymax = mean_length + sd_length), width = 0.2) +
   theme_bw() +
   theme(
      axis.text.x = element_text(angle = 0, hjust = 1), 
      axis.title = element_text(size = 12),
      title = element_text(size = 14)
   ) +
   labs(
      title = "Number of Sites per DMR Region by Chromosome",
      subtitle = "Black lines are the mean +/- standard deviation;\nLight bars are the Max numbr of sites per region;\nDark bars are the average number of sites per region.",
      x = "Chromosome",
      y = "Number of Sites per Region"
   )
```


```{r fig.height=8, fig.width=8}
dmr.info %>%
   filter(region_length != 0) %>% 
   mutate(chromosome = as.numeric(gsub("chr", "", chromosome))) %>%
   group_by(chromosome) %>%
   summarise(num_p_values = length(region_length),
             num_sites = sum(region_length)) %>%
   pivot_longer(cols = -chromosome, names_to = "statistic", values_to = "Value") %>%
   mutate(statistic = ifelse(statistic == "num_sites", "Number of Sites","Number of p-vales")) %>% 
   arrange(chromosome) %>% 
   mutate(chromosome = as.factor(chromosome)) %>% 
   ggplot(aes(x = fct_inorder(chromosome), y = Value)) +
   geom_bar(stat = "identity", fill = "steelblue") +
   facet_wrap(~statistic, nrow=2, scales = "free_y") +   
   theme_bw() +
   theme(
      axis.text.x = element_text(angle = 0, hjust = 1), 
      axis.title = element_text(size = 12),
      title = element_text(size = 14)
   ) +
   labs(
      title = "Number of DMRs/Sites for each Chromosome",
      subtitle = paste0("Number of sites: total number of sites in the DMR;",
                        "\nNumber of DMRs: Total number of Differentially Methylated Regions."),
      x = "Chromosome",
      y = ""
   )
```


```{r fig.height=8, fig.width=8}
dmr.info %>%
   filter(region_length != 0) %>% 
   mutate(chromosome = as.numeric(gsub("chr", "", chromosome))) %>%
   #filter(chromosome == 2) %>% 
   arrange(chromosome) %>% 
   mutate(chromosome = as.factor(chromosome)) %>% 
   ggplot(aes(fill=chromosome)) +
   geom_density(aes(x=region_length, y=after_stat(scaled)), alpha=0.3) +
   theme_bw() +
   theme(
      axis.text.x = element_text(angle = 0, hjust = 1), 
      axis.title = element_text(size = 12),
      title = element_text(size = 14)
   ) +
   labs(
      title = "Distribution of the Number of Sites per DMR,",
      subtitle = paste0("Grouped by Chromosomes."),
      x = "Number of Sites",
      y = "Density"
   )
```


```{r fig.height=8, fig.width=8, echo=FALSE, out.width='100%', fig.align='center', results='asis'}
for (chromosome in paste0("chr",c(1:12,17))) {
   filename = paste0("../graphs/manhattan_plot_",chromosome,"_alpha_1e-04_subset_Blood.png")
   #knitr::include_graphics(filename)
     cat("![](", filename, ")\n\n")
}

```


```{r fig.height=8, fig.width=8}
# 
# dmr.info %>% 
#    filter(region_length != 0) %>% 
#    group_by(chromosome) %>%
#    summarise(
#       Min = min(region_length),
#       Median = median(region_length),
#       Mean = mean(region_length),
#       Max = max(region_length),
#       SD = sd(region_length)
#    )
# 
# dmr.info %>%
#    filter(region_length == 0)
# 
# library(dplyr)
# library(ggplot2)
# library(tidyr)
# 
# stats <- dmr.info %>%
#    filter(region_length != 0) %>% 
#    mutate(chromosome = factor(gsub("chr", "", chromosome), levels = unique(gsub("chr", "", chromosome)))) %>%
#    group_by(chromosome) %>%
#    summarise(
#       Average = mean(region_length),
#       Max = max(region_length),
#       Median = median(region_length)
#    ) %>%
#    ungroup()
# 
# long_stats <- stats %>%
#    pivot_longer(cols = -chromosome, names_to = "Statistic", values_to = "Value")
# 
# ggplot(long_stats, aes(x = chromosome, y = Value, group = Statistic, color = Statistic)) +
#    geom_line() +
#    theme_minimal() +
#    theme(
#       axis.text.x = element_text(angle = 45, hjust = 1),
#       axis.title = element_text(size = 12),
#       title = element_text(size = 14)
#    ) +
#    labs(
#       title = "Chromosomal Statistics of Region Length",
#       x = "Chromosome",
#       y = "Region Length",
#       color = "Statistic"
#    )
# 
# 





```

